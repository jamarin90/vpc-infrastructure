# Configuración de ejemplo para Reverse Proxy a aplicación en Docker
# Copiar a: /etc/nginx/sites-available/mi-app.conf
# Habilitar: ln -s /etc/nginx/sites-available/mi-app.conf /etc/nginx/sites-enabled/

# Ejemplo 1: Aplicación web simple (Node.js, Python, etc.)
server {
    listen 80;
    listen [::]:80;
    server_name app.ejemplo.com;

    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.ejemplo.com;

    ssl_certificate /etc/letsencrypt/live/app.ejemplo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app.ejemplo.com/privkey.pem;
    include snippets/ssl-params.conf;

    access_log /var/log/nginx/app-access.log;
    error_log /var/log/nginx/app-error.log;

    location / {
        # Puerto donde corre tu contenedor Docker
        proxy_pass http://localhost:3000;

        # Headers necesarios para reverse proxy
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# Ejemplo 2: API con rate limiting
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.ejemplo.com;

    ssl_certificate /etc/letsencrypt/live/api.ejemplo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/api.ejemplo.com/privkey.pem;
    include snippets/ssl-params.conf;

    # Rate limiting (definir en nginx.conf o aquí)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    location / {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Ejemplo 3: WebSocket (para apps en tiempo real)
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ws.ejemplo.com;

    ssl_certificate /etc/letsencrypt/live/ws.ejemplo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/ws.ejemplo.com/privkey.pem;
    include snippets/ssl-params.conf;

    location / {
        proxy_pass http://localhost:4000;

        # Configuración específica para WebSockets
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts más largos para WebSocket
        proxy_connect_timeout 7d;
        proxy_send_timeout 7d;
        proxy_read_timeout 7d;
    }
}

# Ejemplo 4: Múltiples contenedores bajo el mismo dominio
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name servicios.ejemplo.com;

    ssl_certificate /etc/letsencrypt/live/servicios.ejemplo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/servicios.ejemplo.com/privkey.pem;
    include snippets/ssl-params.conf;

    # Frontend en React/Vue/etc.
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API Backend
    location /api/ {
        proxy_pass http://localhost:8080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Otro servicio
    location /admin/ {
        proxy_pass http://localhost:9000/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Ejemplo 5: Subdominio para cada contenedor Docker
# app1.ejemplo.com -> Docker contenedor 1 (puerto 3001)
# app2.ejemplo.com -> Docker contenedor 2 (puerto 3002)
# app3.ejemplo.com -> Docker contenedor 3 (puerto 3003)

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app1.ejemplo.com;

    ssl_certificate /etc/letsencrypt/live/app1.ejemplo.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/app1.ejemplo.com/privkey.pem;
    include snippets/ssl-params.conf;

    location / {
        proxy_pass http://localhost:3001;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# Notas de uso con Docker:
#
# 1. Exponer puertos en Docker:
#    docker run -d -p 3000:3000 mi-app
#
# 2. Con docker-compose:
#    services:
#      app:
#        image: mi-app
#        ports:
#          - "3000:3000"
#
# 3. Obtener certificado SSL:
#    certbot --nginx -d app.ejemplo.com
#
# 4. Probar configuración:
#    nginx -t
#
# 5. Recargar Nginx:
#    systemctl reload nginx
