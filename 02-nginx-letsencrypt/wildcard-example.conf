# Configuración de ejemplo para certificado wildcard
#
# Este archivo muestra cómo configurar múltiples subdominios
# usando un único certificado wildcard (*.tu-dominio.com)
#
# Uso:
#   1. Obtén el certificado wildcard:
#      ./get-wildcard-cert.sh tu-dominio.com email@ejemplo.com cloudflare
#
#   2. Copia este archivo:
#      cp wildcard-example.conf /etc/nginx/sites-available/tu-dominio.conf
#
#   3. Edita las variables DOMAIN y los puertos de tus aplicaciones
#
#   4. Habilita y recarga:
#      ln -sf /etc/nginx/sites-available/tu-dominio.conf /etc/nginx/sites-enabled/
#      nginx -t && systemctl reload nginx

# ==============================================================================
# VARIABLES - Modifica estas según tu configuración
# ==============================================================================
# Nota: Nginx no soporta variables en ssl_certificate, debes reemplazar manualmente
# Busca y reemplaza "DOMINIO" por tu dominio real (ejemplo: midominio.com)

# ==============================================================================
# DOMINIO BASE (ejemplo: tu-dominio.com)
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name DOMINIO www.DOMINIO;

    # Redirigir todo HTTP a HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name DOMINIO www.DOMINIO;

    # Certificado wildcard
    ssl_certificate /etc/letsencrypt/live/DOMINIO/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/DOMINIO/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    # Sitio web principal
    root /var/www/DOMINIO;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }

    # Logs específicos
    access_log /var/log/nginx/DOMINIO-access.log;
    error_log /var/log/nginx/DOMINIO-error.log;
}

# ==============================================================================
# API BACKEND (api.tu-dominio.com -> localhost:3000)
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name api.DOMINIO;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.DOMINIO;

    # Mismo certificado wildcard
    ssl_certificate /etc/letsencrypt/live/DOMINIO/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/DOMINIO/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 90;
    }

    access_log /var/log/nginx/api.DOMINIO-access.log;
    error_log /var/log/nginx/api.DOMINIO-error.log;
}

# ==============================================================================
# APLICACIÓN WEB (app.tu-dominio.com -> localhost:8080)
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name app.DOMINIO;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name app.DOMINIO;

    ssl_certificate /etc/letsencrypt/live/DOMINIO/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/DOMINIO/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    location / {
        proxy_pass http://localhost:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    access_log /var/log/nginx/app.DOMINIO-access.log;
    error_log /var/log/nginx/app.DOMINIO-error.log;
}

# ==============================================================================
# ADMIN PANEL (admin.tu-dominio.com -> localhost:9000)
# Ejemplo con autenticación básica adicional
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name admin.DOMINIO;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name admin.DOMINIO;

    ssl_certificate /etc/letsencrypt/live/DOMINIO/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/DOMINIO/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    # Autenticación básica opcional
    # Crear con: htpasswd -c /etc/nginx/.htpasswd usuario
    # auth_basic "Area Restringida";
    # auth_basic_user_file /etc/nginx/.htpasswd;

    location / {
        proxy_pass http://localhost:9000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    access_log /var/log/nginx/admin.DOMINIO-access.log;
    error_log /var/log/nginx/admin.DOMINIO-error.log;
}

# ==============================================================================
# BLOG / SITIO ESTÁTICO (blog.tu-dominio.com)
# ==============================================================================
server {
    listen 80;
    listen [::]:80;
    server_name blog.DOMINIO;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name blog.DOMINIO;

    ssl_certificate /etc/letsencrypt/live/DOMINIO/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/DOMINIO/privkey.pem;
    include /etc/nginx/snippets/ssl-params.conf;

    root /var/www/blog.DOMINIO;
    index index.html index.htm;

    location / {
        try_files $uri $uri/ =404;
    }

    # Cache para archivos estáticos
    location ~* \.(jpg|jpeg|png|gif|ico|css|js|woff|woff2)$ {
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    access_log /var/log/nginx/blog.DOMINIO-access.log;
    error_log /var/log/nginx/blog.DOMINIO-error.log;
}

# ==============================================================================
# SUBDOMINIO CATCH-ALL (cualquier otro subdominio)
# Opcional: redirige subdominios no configurados al dominio principal
# ==============================================================================
# server {
#     listen 80 default_server;
#     listen [::]:80 default_server;
#     listen 443 ssl http2 default_server;
#     listen [::]:443 ssl http2 default_server;
#     server_name *.DOMINIO;
#
#     ssl_certificate /etc/letsencrypt/live/DOMINIO/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/DOMINIO/privkey.pem;
#
#     return 301 https://DOMINIO$request_uri;
# }
